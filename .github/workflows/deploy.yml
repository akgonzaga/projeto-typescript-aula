name: CI/CD - Pipeline - INDT

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout do código
        # the action name is lowercase (`actions/checkout`) – GitHub normalises most of the
        # path but it's good to keep the documented spelling to avoid confusion.
        uses: actions/checkout@v4

      # - name: Restart Docker
      #   run: |
      #       sudo /usr/local/bin/docker-restart.sh
      #       sleep 10

      - name: Login no Github Container Registry
        run: |
              # some Docker builds (or older client versions) don't recognise the shorthand
              # `-u` flag on `docker login`. use the long option to be safe and keep the
              # command lowercase (`login` instead of `Login`).
              echo "${{ secrets.GHCR_TOKEN }}" | \
                docker login ghcr.io --username ${{ github.actor }} --password-stdin
      - name: Remover Container Antigo
        run:  |
              docker compose down || true

      - name: Build da Imagem
        run: |
          # the original lines split the tag into two lines and misspelled "latest";
          # also you need to specify a build context (here we assume the repository root).
          docker build -t ghcr.io/akgonzaga/turma01:latest .

      - name: Push Imagem
        run: |
              docker push ghcr.io/akgonzaga/turma01:latest

      - name: Cria o .env na VM
        run: |
            cat > .env << EOF
            DB_HOST=postgres
            DB_PORT=${{ secrets.DB_PORT }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            DB_NAME=${{ secrets.DB_NAME }}
            NODE_ENV=production
            PORT=6060
            JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            EOF

      - name: Subir docker
        run: |
              docker compose up -d --build

      - name: Verificar se Subiu
        run: |
              sleep 10
              docker compose ps